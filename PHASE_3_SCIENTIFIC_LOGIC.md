# Phase 3: Scientific Logic (Taxonomy & Novelty)

## Overview

Phase 3 is the decision-making core of Global-BioScan. It combines vector search, weighted taxonomic consensus, and unsupervised clustering to identify *Novel Taxonomic Units (NTUs)* from deep-sea eDNA sequences.

This document explains the reasoning, thresholds, and voting math used in `src/edge/taxonomy.py` and `src/edge/discovery.py`.

---

## 1. Vector Search → Candidate Taxonomy

### Goal
Given a query embedding, retrieve the top-$k$ most similar embeddings from LanceDB and infer taxonomy based on their lineages.

### Mechanism
- **Vector store:** LanceDB table `obis_reference_index`
- **Distance:** Cosine distance (lower = closer)
- **Similarity:** Converted to $[0,1]$ using:

$$
\text{similarity} = 1 - \frac{\text{cosine\_distance}}{2}
$$

### Output
A neighbor table containing:
- `taxonomy` (lineage string)
- `distance`
- `similarity`

---

## 2. Weighted Consensus Voting

### Goal
Derive a consensus lineage from the top-$k$ neighbors, weighted by similarity.

### Voting Strategy
Each neighbor contributes a vote weight equal to its similarity score.

Let $L_i$ be the lineage of neighbor $i$, and $s_i$ be its similarity.

The total weight for each lineage is:

$$
W(L) = \sum_{i: L_i = L} s_i
$$

The winning lineage is:

$$
L^* = \arg\max_L W(L)
$$

### Confidence Score
The confidence is computed as:

$$
\text{confidence} = \frac{W(L^*)}{\sum_i s_i} \times 100
$$

### Example
If 8 of 10 neighbors vote for *Cnidaria*, and their similarities are higher, the consensus lineage becomes *Cnidaria* with high confidence.

---

## 3. TaxonKit Standardization

To avoid inconsistent naming (e.g., "Cnidaria" vs "Cnidaria (clade)"), the top candidate names are standardized using TaxonKit:

```bash
echo "Cnidaria" | taxonkit name2taxid | taxonkit reformat -f "{k};{p};{c};{o};{f};{g};{s}" -t
```

This produces a clean 7-level lineage:

```
Eukaryota;Animalia;Cnidaria;Anthozoa;Scleractinia;Acropora;Acropora cervicornis
```

---

## 4. Novelty Thresholding

### Goal
Identify sequences that are *too dissimilar* from any known reference taxa.

### Rule
If the top neighbor similarity is below a threshold, the sequence is flagged as novel:

$$
\text{if } s_{\max} < 0.85 \Rightarrow \text{STATUS\_NOVEL}
$$

### Rationale
- Values above $0.85$ typically indicate high taxonomic concordance.
- Values below $0.85$ often represent unknown or poorly represented taxa.

This is configurable via `novelty_threshold` in `NoveltyDetector`.

---

## 5. HDBSCAN Clustering (Novelty Pool)

### Goal
Group novel sequences into candidate NTUs using unsupervised clustering.

### Algorithm
We use **HDBSCAN**, a density-based clustering algorithm well-suited for noisy biological data.

**Parameters:**
- Windows (fast): `min_cluster_size=5`, `min_samples=3`
- Colab (heavy): `min_cluster_size=10`, `min_samples=5`

### Output
Each cluster is labeled:

```
Candidate_NTU_1, Candidate_NTU_2, ...
```

### Centroid Definition
A cluster centroid is defined as the *most representative vector*, i.e., the member closest to the cluster mean.

---

## 6. Discovery Summary

The system reports results in a human-readable summary:

```
Found 150 sequences. 120 assigned to known taxa.
30 sequences formed 3 novel clusters (potential new species).
```

This summary is generated by:

```python
NoveltyDetector.generate_discovery_summary()
```

---

## 7. Hybrid Environment Support

The system adapts to the environment:

| Environment | Clustering Parameters | Rationale |
|------------|------------------------|-----------|
| Windows Laptop | `min_cluster_size=5` | Fast, responsive UI |
| Google Colab | `min_cluster_size=10` | More robust discovery |

Detection logic:
```python
if "google.colab" in sys.modules:
    # Use larger clustering parameters
```

---

## 8. Scientific Rationale Summary

✅ **Vector search + consensus** ensures robust, similarity-weighted taxonomy assignment.  
✅ **TaxonKit standardization** prevents taxonomy mismatches and inconsistent labels.  
✅ **Novelty thresholding** ensures sequences outside known databases are flagged.  
✅ **HDBSCAN clustering** discovers novel groups without supervision.  
✅ **Centroid extraction** provides a representative NTU reference.  

---

## 9. Future Extensions

- Add **phylogenetic tree reconstruction** for NTUs.
- Calibrate novelty threshold using labeled validation datasets.
- Integrate **bootstrap consensus** for taxonomic voting.
- Expand **similarity thresholds** per gene marker (COI vs 18S).

---

## References

- HDBSCAN: https://hdbscan.readthedocs.io/
- LanceDB: https://lancedb.com/
- TaxonKit: https://bioinf.shenwei.me/taxonkit/
- Nucleotide Transformers: https://github.com/instadeepai/nucleotide-transformer
